<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Shaheen Automotive Pvt Ltd</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family: Arial, Helvetica, sans-serif; background:#f4f6f8; margin:0; padding:18px;}
    .card{background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.06);}
    
    /* NEW HEADER */
    .top-header{
      width:100%;
      background:#0a0a0a;
      padding:10px 15px;
      display:flex;
      align-items:center;
      gap:15px;
      margin-bottom:15px;
      border-radius:6px;
    }
    .top-header img{
      height:40px;
      border-radius:4px;
    }
    .top-header-title{
      font-size:20px;
      font-weight:bold;
      color:white;
      letter-spacing:1px;
    }

    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    h1{font-size:18px;margin:0;}
    .small{font-size:13px;color:#666;}
    select,input[type=text],input[type=password],input[type=number]{padding:6px;border:1px solid #ddd;border-radius:6px;}
    button{padding:7px 10px;border-radius:6px;border:0;background:#0366d6;color:#fff;cursor:pointer;}
    button.ghost{background:#eee;color:#222;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}
    th,td{padding:6px;border:1px solid #eee;text-align:left;}
    th{background:#fafafa;}
    .muted{color:#888;}
    .controls{display:flex;gap:8px;align-items:center;}
    .right{display:flex;gap:8px;align-items:center;}
    .admin-panel{margin-top:12px;padding:10px;border-radius:6px;background:#fbfbfb;border:1px solid #efefef;}
    .note{font-size:12px;color:#555;margin-top:8px;}
    input[type=number]{width:80px;}
  </style>
</head>
<body>

  <!-- NEW HEADER -->
  <div class="top-header">
    <img src="https://raw.githubusercontent.com/SAPL-bit/SAPL-APP/refs/heads/main/1764832506974.jpg" alt="Logo">
    <div class="top-header-title">Shaheen Automotive Pvt Ltd</div>
  </div>

  <div class="card" id="app">
    <header>
      <div>
        <div class="small">Local demo app â€” runs by double-clicking <code>index.html</code></div>
      </div>
      <div class="right">
        <div id="loggedAs" class="small muted">Not logged in</div>
        <button id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <div id="loginBox" class="card" style="margin-bottom:10px;">
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="userSelect"></select>
        <input id="pwd" type="password" placeholder="Password" />
        <button id="loginBtn">Login</button>
        <button id="resetSample" class="ghost">Reset sample data</button>
      </div>
      <div class="note">Default users: production / store / welding / fg / admin. Passwords are shown in the login dropdown for demo.</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
      <input id="search" type="text" placeholder="Search part code or name" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;" />
      <button id="refreshBtn" class="ghost">Refresh</button>
      <button id="exportBtn" class="ghost">Export CSV</button>
    </div>

    <div class="card" id="tableCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin
        <script>
(function(){
  const LS_KEY = 'shaheen_auto_v1';
  const PART_COUNT = 200;

  const users = [
    {username:'production', label:'Production House', password:'prod123', role:'production'},
    {username:'store', label:'Store', password:'store123', role:'store'},
    {username:'welding', label:'Welding', password:'weld123', role:'welding'},
    {username:'fg', label:'FG Store', password:'fg123', role:'fg'},
    {username:'admin', label:'Administrator', password:'admin123', role:'admin'}
  ];

  const roleEditable = {
    production: ['todayProduction','finalDone'],
    store: ['outStock'],
    welding: ['finalDone'],
    fg: ['outStock'],
    admin: ['partName','openingStock','todayProduction','storeQty','weldingQty','fgQty','monthlySupplyOrder','outStock','finalDone']
  };

  function generateParts(n){
    const arr=[];
    for(let i=1;i<=n;i++){
      arr.push({
        id:i,
        partCode:`P-${String(i).padStart(4,'0')}`,
        partName:`Part ${i}`,
        openingStock: Math.floor(Math.random()*1000),
        todayProduction:0,
        storeQty: Math.floor(Math.random()*200),
        weldingQty: 0,
        fgQty: Math.floor(Math.random()*300),
        monthlySupplyOrder: Math.floor(Math.random()*5000),
        autoOrderToProduction:0,
        outStock:0,
        finalDone:0
      });
    }
    return arr;
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return {company:'Shaheen Auto Parts', parts: generateParts(PART_COUNT)};
  }

  function saveData(obj){
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
    window.dispatchEvent(new Event('storage'));
  }

  let state = loadData();
  let currentUser = null;

  const userSelect = document.getElementById('userSelect');
  const pwdInput = document.getElementById('pwd');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loggedAs = document.getElementById('loggedAs');

  const partsTableBody = document.querySelector('#partsTable tbody');
  const partsCount = document.getElementById('partsCount');
  const searchInput = document.getElementById('search');
  const refreshBtn = document.getElementById('refreshBtn');
  const exportBtn = document.getElementById('exportBtn');
  const autoOrderBtn = document.getElementById('autoOrderBtn');

  const adminPanelBtn = document.getElementById('adminPanelBtn');
  const adminPanel = document.getElementById('adminPanel');
  const addPartBtn = document.getElementById('addPartBtn');
  const clearPartsBtn = document.getElementById('clearPartsBtn');
  const regenBtn = document.getElementById('regenBtn');
  const loginBox = document.getElementById('loginBox');
  const resetSample = document.getElementById('resetSample');

  function populateUserSelect(){
    userSelect.innerHTML = '';
    users.forEach(u=>{
      const opt = document.createElement('option');
      opt.value = u.username;
      opt.textContent = `${u.label} (${u.username} / ${u.password})`;
      userSelect.appendChild(opt);
    });
  }

  function renderTable(){
    const q = searchInput.value.trim().toLowerCase();
    const rows = state.parts.filter(p =>
      (!q) || p.partCode.toLowerCase().includes(q) || p.partName.toLowerCase().includes(q)
    );

    partsTableBody.innerHTML = '';
    rows.forEach(p=>{
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.partCode}</td>
        <td><input data-id="${p.id}" data-field="partName" value="${escapeHtml(p.partName)}" /></td>
        <td><input data-id="${p.id}" data-field="openingStock" type="number" value="${p.openingStock}" /></td>
        <td><input data-id="${p.id}" data-field="todayProduction" type="number" value="${p.todayProduction}" /></td>
        <td>${p.storeQty}</td>
        <td>${p.weldingQty}</td>
        <td>${p.fgQty}</td>
        <td><input data-id="${p.id}" data-field="monthlySupplyOrder" type="number" value="${p.monthlySupplyOrder}" /></td>
        <td>${p.autoOrderToProduction || 0}</td>
        <td><input data-id="${p.id}" data-field="outStock" type="number" value="${p.outStock}" /></td>
        <td><input data-id="${p.id}" data-field="finalDone" type="number" value="${p.finalDone}" /></td>
        <td><button class="applyFinal" data-id="${p.id}">Apply->FG</button></td>
      `;

      tr.querySelectorAll('input').forEach(inp=>{
        const field = inp.dataset.field;
        if(currentUser.role!=='admin' && !roleEditable[currentUser.role].includes(field)){
          inp.disabled = true;
        }else{
          inp.disabled = false;
        }
      });

      partsTableBody.appendChild(tr);
    });

    partsCount.textContent = rows.length;
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g,m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
    }[m]));
  }

  partsTableBody.addEventListener('input', e=>{
    const inp = e.target;
    if(!inp.dataset.id) return;
    const id = Number(inp.dataset.id);
    const field = inp.dataset.field;

    const part = state.parts.find(p=>p.id===id);
    if(!part) return;

    part[field] = (inp.type==='number'? Number(inp.value): inp.value);
    saveData(state);
  });

  partsTableBody.addEventListener('click', e=>{
    if(e.target.classList.contains('applyFinal')){
      const id = Number(e.target.dataset.id);
      const p = state.parts.find(x=>x.id===id);
      if(!p) return;

      p.fgQty += p.finalDone;
      p.finalDone = 0;
      saveData(state);
      renderTable();
    }
  });

  loginBtn.addEventListener('click', ()=>{
    const u = users.find(x=>x.username===userSelect.value);
    if(!u) return alert("User not found");

    if(pwdInput.value !== u.password){
      alert("Wrong password");
      return;
    }

    currentUser = u;
    loggedAs.textContent = `Logged in as: ${u.label}`;
    loginBox.style.display='none';
    logoutBtn.style.display='inline-block';

    if(u.role==='admin'){
      adminPanelBtn.style.display='inline-block';
    }else{
      adminPanelBtn.style.display='none';
      adminPanel.style.display='none';
    }

    renderTable();
  });

  logoutBtn.addEventListener('click', ()=>{
    currentUser = null;
    loggedAs.textContent = "Not logged in";
    loginBox.style.display='block';
    logoutBtn.style.display='none';
    adminPanel.style.display='none';
    renderTable();
  });

  adminPanelBtn.addEventListener('click', ()=>{
    adminPanel.style.display = adminPanel.style.display==='none'?'block':'none';
  });

  addPartBtn.addEventListener('click', ()=>{
    const id = state.parts.length? (Math.max(...state.parts.map(x=>x.id))+1):1;
    state.parts.push({
      id,
      partCode:`P-${String(id).padStart(4,'0')}`,
      partName:`Part ${id}`,
      openingStock:0,
      todayProduction:0,
      storeQty:0,
      weldingQty:0,
      fgQty:0,
      monthlySupplyOrder:0,
      autoOrderToProduction:0,
      outStock:0,
      finalDone:0
    });
    saveData(state);
    renderTable();
  });

  clearPartsBtn.addEventListener('click', ()=>{
    if(confirm("Delete ALL parts?")){
      state.parts = [];
      saveData(state);
      renderTable();
    }
  });

  regenBtn.addEventListener('click', ()=>{
    if(confirm("Recreate sample 200 parts?")){
      state.parts = generateParts(PART_COUNT);
      saveData(state);
      renderTable();
    }
  });

  resetSample.addEventListener('click', ()=>{
    if(confirm("Reset everything to sample data?")){
      state = {company:'Shaheen Auto Parts', parts:generateParts(PART_COUNT)};
      saveData(state);
      renderTable();
    }
  });

  refreshBtn.addEventListener('click', renderTable);
  searchInput.addEventListener('input', renderTable);

  exportBtn.addEventListener('click', ()=>{
    let csv = "ID,Code,Name,Opening,TodayProd,Store,Wel,FG,Monthly,AutoOrd,Out,Final\n";
    state.parts.forEach(p=>{
      csv += [
        p.id,p.partCode,p.partName,p.openingStock,p.todayProduction,
        p.storeQty,p.weldingQty,p.fgQty,p.monthlySupplyOrder,p.autoOrderToProduction,
        p.outStock,p.finalDone
      ].join(',') + "\n";
    });

    const blob = new Blob([csv],{type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "parts.csv";
    a.click();
  });

  populateUserSelect();
  renderTable();

})();
</script>

</body>
</html>
